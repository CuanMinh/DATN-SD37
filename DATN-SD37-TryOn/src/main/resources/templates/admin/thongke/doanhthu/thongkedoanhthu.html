<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/index.html}">
<head>
    <meta charset="UTF-8">
    <title>Thống kê doanh thu</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div layout:fragment="content" class="col-lg-10 my-4"
     style="min-height: 600px; border: 1px solid rgba(128, 128, 128, 0.212);">
    <h2 class="mb-4">Thống kê doanh thu</h2>

    <!-- Form chọn loại thống kê (sẽ dùng JavaScript để gọi AJAX) -->
    <form id="filterForm" class="mb-4 d-flex align-items-center">
        <label for="type" class="me-2 fw-bold">Chọn loại thống kê:</label>
        <select id="type" name="type" class="form-control w-auto">
            <option value="ngay">Theo ngày</option>
            <option value="thang">Theo tháng</option>
            <option value="nam">Theo năm</option>
        </select>
        <button type="submit" class="btn btn-primary ms-3">Lọc</button>
    </form>

    <!-- Biểu đồ doanh thu -->
    <canvas id="revenueChart"></canvas>

    <!-- Bảng thống kê doanh thu -->
    <table class="table table-bordered mt-4">
        <thead>
        <tr class="table-dark">
            <th>Thời gian</th>
            <th>Doanh thu</th>
        </tr>
        </thead>
        <tbody id="revenueTableBody">
        <!-- Dữ liệu sẽ được điền bằng JavaScript -->
        </tbody>
    </table>
</div>

<script>
    // Khai báo biến chart toàn cục để có thể cập nhật lại nếu cần
    let revenueChart;

    // Gọi hàm fetchData() khi trang vừa load
    window.addEventListener('load', function() {
        fetchData("ngay"); // Mặc định là "ngay"
    });

    // Lắng nghe sự kiện submit của form để gọi AJAX
    document.getElementById("filterForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const type = document.getElementById("type").value;
        fetchData(type);
    });

    // Hàm fetchData để gọi AJAX đến /data
    function fetchData(type) {
        fetch(`/admin/thongkedoanhthu/data?type=${type}`)
            .then(response => response.json())
            .then(data => {
                // Dữ liệu JSON trả về
                const labels = data.map(item => item.thoiGian);
                const doanhThu = data.map(item => item.tongDoanhThu);

                // Cập nhật biểu đồ
                updateChart(labels, doanhThu);

                // Cập nhật bảng dữ liệu
                updateTable(data);
            })
            .catch(error => console.error("Error fetching data:", error));
    }

    // Cập nhật biểu đồ doanh thu
    function updateChart(labels, data) {
        const ctx = document.getElementById('revenueChart').getContext('2d');

        // Nếu đã có chart, ta hủy nó trước khi tạo mới để tránh vẽ chồng
        if (revenueChart) {
            revenueChart.destroy();
        }

        revenueChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Doanh thu',
                    data: data,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    // Cập nhật bảng thống kê
    function updateTable(data) {
        const tbody = document.getElementById("revenueTableBody");
        tbody.innerHTML = "";

        data.forEach(item => {
            // Sử dụng toLocaleString() để format số
            const formattedDoanhThu = item.tongDoanhThu.toLocaleString('vi-VN');
            const row = `
                <tr>
                    <td>${item.thoiGian}</td>
                    <td>${formattedDoanhThu} ₫</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
</script>

</body>
</html>
